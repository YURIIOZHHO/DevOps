pipeline {
    agent {
        docker { image 'python:3.10' }
    }

    environment {
        APP_DIR = "CI-CD/Jenkins/automate-nightly-backup/python-app"
    }

    stages{
            
        stage('Install dependincies') {
            steps{
                dir(APP_DIR){
                    sh '''#!/bin/bash
                    python3 -m venv venv
                    source venv/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                    '''
                }
           
            }
        }
            

        stage('Test') {
            steps{
                dir(APP_DIR){
                    sh'''#!/bin/bash
                    source venv/bin/activate
                    python3 tests/test.py
                    '''
                } 
            }
        }

        stage('Build') {
            steps{
                 dir(APP_DIR){
                        sh'''#!/bin/bash
                        source venv/bin/activate
                        python3 app.py &
                        PID=$!
                        wait $PID
                        tar -czf build-$(date +%Y$m%d-%H%M%S).tar.gz .
                        '''
                 }
            }
        }

        stage('Trigger Nighlty Backup'){
            steps {
                build job: 'backup', wait: false
            }
        }
            
    }
}


