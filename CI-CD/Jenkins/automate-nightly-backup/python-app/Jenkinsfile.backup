pipeline {
    agent any
    environment {
        APP_DIR = "artifacts"
        S3_BUCKET_PATH = "s3://python-app-nightly-backup/python-project/"
    }

    stages {
        stage('Retrieve Latest Build') {
            steps {
                copyArtifacts(
                    projectName: 'python',
                    filter: 'artifacts/*.tar.gz',
                    selector: lastSuccessful()
                )
            }
        }

        stage('Backup build to S3') {
            steps {
                dir(APP_DIR) {
                    script {
                        docker.image('amazon/aws-cli:latest').inside('--entrypoint=""') {
                            withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-creds']]) {
                                sh '''
                                LATEST_BUILD=$(ls -t *.tar.gz 2>/dev/null | head -1)
                                if [ -z "$LATEST_BUILD" ]; then
                                    echo " No build files found"
                                    exit 1
                                fi
                                echo "Uploading $LATEST_BUILD to S3"
                                aws s3 cp "$LATEST_BUILD" "$S3_BUCKET_PATH"
                                '''
                            }
                        }
                    }
                }
            }
        }

    }
}
